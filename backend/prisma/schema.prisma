// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                        String      @id @default(cuid())
  phone_number              String      @unique
  name                      String
  email                     String?     @unique
  password                  String      // <--- ADDED: Required for login
  profile_picture           String?
  is_responder              Boolean     @default(false)
  is_admin                  Boolean     @default(false)
  created_at                DateTime    @default(now())
  updated_at                DateTime    @updatedAt

  // Responder specific fields
  is_certified              Boolean?    @default(false)
  is_available              Boolean?    @default(false)
  certification_type        String?
  certification_uploaded_at DateTime?
  exam_passed               Boolean     @default(false)
  exam_score                Float?
  exam_completed_at         DateTime?
  latitude                  Float?
  longitude                 Float?
  successful_responses      Int         @default(0)
  emergency_alerts_received Int         @default(0)
  total_lives_helped        Int         @default(0)

  // Relations
  created_emergencies       Emergency[] @relation("UserEmergencies")
  responded_emergencies     Emergency[] @relation("ResponderEmergencies")
  exam_results              ExamResult[]

  @@index([phone_number])
  @@index([is_responder])
  @@index([is_admin])
  @@index([is_available])
}

model Emergency {
  id              String    @id @default(cuid())
  user_id         String
  user            User      @relation("UserEmergencies", fields: [user_id], references: [id])
  responder_id    String?
  responder       User?     @relation("ResponderEmergencies", fields: [responder_id], references: [id])
  
  latitude        Float
  longitude       Float
  emergency_type  String    // 'Cardiac', 'Bleeding', 'Choking', 'Fracture', 'Other'
  status          String    @default("pending") // 'pending', 'in-progress', 'resolved'
  description     String?
  
  created_at      DateTime  @default(now())
  resolved_at     DateTime?
  updated_at      DateTime  @updatedAt

  // Relations
  alerts          EmergencyAlert[]
  updates         LocationUpdate[]

  @@index([user_id])
  @@index([responder_id])
  @@index([status])
  @@index([created_at])
}

model EmergencyAlert {
  id              String    @id @default(cuid())
  emergency_id    String
  emergency       Emergency @relation(fields: [emergency_id], references: [id], onDelete: Cascade)
  responder_id    String
  
  distance        Int       // Distance in meters
  status          String    @default("pending") // 'pending', 'accepted', 'declined'
  sent_at         DateTime  @default(now())
  responded_at    DateTime?

  @@index([emergency_id])
  @@index([responder_id])
  @@index([status])
}

model LocationUpdate {
  id              String    @id @default(cuid())
  emergency_id    String
  emergency       Emergency @relation(fields: [emergency_id], references: [id], onDelete: Cascade)
  
  user_id         String
  latitude        Float
  longitude       Float
  timestamp       DateTime

  @@index([emergency_id])
  @@index([user_id])
  @@index([timestamp])
}

model Resource {
  id              String    @id @default(cuid())
  name            String
  type            String    // 'hospital', 'pharmacy', 'clinic', etc.
  latitude        Float
  longitude       Float
  phone           String?
  address         String?
  is_24_hours     Boolean   @default(false)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@index([type])
  @@index([latitude, longitude])
}

model Exam {
  id                String    @id @default(cuid())
  title             String
  description       String?
  questions         String    // <--- CHANGED: Json -> String (for SQLite compatibility)
  passing_score     Int       @default(70) // Percentage
  duration_minutes  Int       @default(30)
  is_active         Boolean   @default(true)
  
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  results           ExamResult[]

  @@index([is_active])
}

model ExamResult {
  id                String    @id @default(cuid())
  user_id           String
  user              User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  exam_id           String
  exam              Exam      @relation(fields: [exam_id], references: [id], onDelete: Cascade)
  
  score             Float     // Percentage score
  total_questions   Int
  correct_answers   Int
  answers           String    // <--- CHANGED: Json -> String (for SQLite compatibility)
  passed            Boolean
  location_lat      Float?    // Location when exam was taken
  location_lng      Float?
  
  started_at        DateTime
  submitted_at      DateTime

  @@index([user_id])
  @@index([exam_id])
  @@index([passed])
}